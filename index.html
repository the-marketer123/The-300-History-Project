<!DOCTYPE html>
<html>
    <head>
        <title>300 - The Game</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script><!--J Query-->
        <script src='https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js'></script><!--GL Matrix-->
        <style>
            body {
                margin: 0;
                overflow: hidden;
                font-family: Trebuchet MS;
                background-color: black; /* Black screen before start */
            }

            #ui-canvas {
                
                position:fixed;
                z-index:-1;
            }
        </style>
    </head>
    
    <body>
        <script type="importmap">
            {
                "imports": {
                "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.172.0/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/",
                "@dimforge/rapier3d-compat": "https://cdn.skypack.dev/@dimforge/rapier3d-compat"
                }
            }
        </script>


        <!--<img id="titlebackground" src='assets/title_background.webp'>-->
        <canvas id="ui-canvas"></canvas>

        <audio autoplay loop muted id="title_song">
            <source src="assets/title_song.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>

        <script type="module">
            import * as THREE from 'three';
            import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
            import { Sky } from 'three/addons/objects/Sky.js';
            import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
            import  Stats  from 'three/addons/libs/stats.module.js'
            const RAPIER = await import('https://cdn.skypack.dev/@dimforge/rapier3d-compat@0.11.2');
            await RAPIER.init();
            console.log(GLTFLoader)

            let uiCanvas=document.getElementById('ui-canvas')
            let ui_ctx=uiCanvas.getContext('2d')
            function resizeCanvas() {
                uiCanvas.width = window.innerWidth;
                uiCanvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);


            /*Start Button*/
                let showStartButton = true;
                const startbutton = {
                    x: uiCanvas.width / 2 - 100,
                    y: uiCanvas.height / 2 - 30,
                    width: 200,
                    height: 60,
                    text: 'START',
                    hovered: false
                };

                // Draw loop
                function drawStartButton() {
                    ui_ctx.clearRect(0, 0, uiCanvas.width, uiCanvas.height);

                    // Update startbutton position in case of resize
                    startbutton.x = uiCanvas.width / 2 - 100;
                    startbutton.y = uiCanvas.height / 2 - 30;

                    // startbutton background
                    ui_ctx.beginPath();
                    ui_ctx.roundRect(startbutton.x, startbutton.y, startbutton.width, startbutton.height, 15);
                    ui_ctx.fillStyle = startbutton.hovered ? '#00f0ff' : '#0077cc';
                    ui_ctx.fill();

                    // startbutton glow
                    if (startbutton.hovered) {
                    ui_ctx.shadowColor = '#00ffff';
                    ui_ctx.shadowBlur = 20;
                    } else {
                    ui_ctx.shadowBlur = 0;
                    }

                    // startbutton text
                    ui_ctx.font = 'bold 24px sans-serif';
                    ui_ctx.fillStyle = '#ffffff';
                    ui_ctx.textAlign = 'center';
                    ui_ctx.textBaseline = 'middle';
                    ui_ctx.fillText(startbutton.text, uiCanvas.width / 2, uiCanvas.height / 2);

                    //requestAnimationFrame(drawStartButton);
                }

                // Mouse detection
                uiCanvas.addEventListener("mousemove", (e) => {
                    if (!showStartButton) return;

                    const rect = uiCanvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;

                    startbutton.hovered = (
                        mx >= startbutton.x && mx <= startbutton.x + startbutton.width &&
                        my >= startbutton.y && my <= startbutton.y + startbutton.height
                    );
                });


                // Click to start music and remove canvas
                uiCanvas.addEventListener("click", () => {
                    if (showStartButton && startbutton.hovered) {
                        const audio = document.getElementById("title_song");
                        audio.muted = false;
                        audio.play();

                        // Set background image
                        document.body.style.backgroundImage = "url('assets/title_background.png')";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundSize = "cover";
                        document.body.style.backgroundAttachment = "fixed";

                        // Disable the start button (but keep canvas)
                        showStartButton = false;

                        // Optional: trigger game start or something here
                    }
                });


                // RoundRect polyfill for older browsers
                if (!CanvasRenderingContext2D.prototype.roundRect) {
                    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                    if (typeof r === 'number') r = { tl: r, tr: r, br: r, bl: r };
                    this.beginPath();
                    this.moveTo(x + r.tl, y);
                    this.lineTo(x + w - r.tr, y);
                    this.quadraticCurveTo(x + w, y, x + w, y + r.tr);
                    this.lineTo(x + w, y + h - r.br);
                    this.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
                    this.lineTo(x + r.bl, y + h);
                    this.quadraticCurveTo(x, y + h, x, y + h - r.bl);
                    this.lineTo(x, y + r.tl);
                    this.quadraticCurveTo(x, y, x + r.tl, y);
                    this.closePath();
                    return this;
                    };
                }

                drawStartButton();
            /*Title*/
                let titleText = "The 300";
                let subtitleText = "The Game";
                let startText = "Begin";
                let titleAlpha = 0; // Controls fade-in effect
                let titleFadeSpeed = 0.02; // Adjust this for faster/slower fade-in

                let gameStarted = false;


                const beginButton = {
                    x: 0,
                    y: 0,
                    width: 200,
                    height: 60,
                    hovered: false,
                    scale: 1,
                    targetScale: 1
                };
                // Function to draw the title
                function drawTitle() {
                    ui_ctx.save();

                    // Title Text
                    ui_ctx.shadowColor = "rgba(255, 223, 186, 0.8)";
                    ui_ctx.shadowBlur = 20;
                    ui_ctx.font = "150px 'Pirata One', serif";
                    ui_ctx.fillStyle = `rgba(0, 0, 0, ${titleAlpha})`;
                    ui_ctx.textAlign = "center";
                    ui_ctx.textBaseline = "middle";
                    ui_ctx.fillText("The 300", uiCanvas.width / 2, uiCanvas.height / 6);
                    ui_ctx.font = "50px 'Pirata One', serif";
                    ui_ctx.fillText("The Game", uiCanvas.width / 2, uiCanvas.height / 6 + 100);

                    // Begin button animation
                    beginButton.targetScale = beginButton.hovered ? 1.05 : 1;
                    beginButton.scale += (beginButton.targetScale - beginButton.scale) * 0.1;

                    const btnW = beginButton.width * beginButton.scale;
                    const btnH = beginButton.height * beginButton.scale + 100;
                    beginButton.x = uiCanvas.width / 2 - btnW / 2;
                    beginButton.y = uiCanvas.height / 2;

                    // Draw the button
                    ui_ctx.shadowBlur = beginButton.hovered ? 20 : 0;
                    ui_ctx.shadowColor = "#00ffff";
                    ui_ctx.font = "bold " + (beginButton.scale * 50) + "px 'Pirata One', serif";
                    ui_ctx.fillStyle = `rgba(0, 0, 0, ${titleAlpha})`;
                    ui_ctx.textAlign = "center";
                    ui_ctx.textBaseline = "middle";
                    ui_ctx.fillText("Begin", uiCanvas.width / 2, beginButton.y + btnH / 2);

                    ui_ctx.restore();

                    // Fade in
                    if (titleAlpha < 1) {
                        titleAlpha += titleFadeSpeed;
                    }
                }

                uiCanvas.addEventListener("mousemove", (e) => {
                    if (gameStarted) return;

                    const rect = uiCanvas.getBoundingClientRect();
                    const mx = e.clientX - rect.left;
                    const my = e.clientY - rect.top;

                    const btnW = beginButton.width * beginButton.scale;
                    const btnH = beginButton.height * beginButton.scale + 100;
                    const bx = uiCanvas.width / 2 - btnW / 2;
                    const by = uiCanvas.height / 2;

                    beginButton.hovered = (
                        mx >= bx && mx <= bx + btnW &&
                        my >= by && my <= by + btnH
                    );
                });

                uiCanvas.addEventListener("click", () => {
                    if (gameStarted || titleAlpha < 1) return;

                    if (beginButton.hovered) {
                        gameStarted = true;

                        const audio = document.getElementById("title_song");
                        audio.muted = false;
                        audio.play();

                        // Show background
                        document.body.style.backgroundImage = "url('assets/title_background.png')";
                        document.body.style.backgroundRepeat = "no-repeat";
                        document.body.style.backgroundSize = "cover";
                        document.body.style.backgroundAttachment = "fixed";

                        // Optional: trigger next scene, hide UI etc
                    }
                });





                // Load the pirate-style font dynamically
                const pirateFont = document.createElement("link");
                pirateFont.href = "https://fonts.googleapis.com/css2?family=Pirata+One&display=swap";
                pirateFont.rel = "stylesheet";
                document.head.appendChild(pirateFont);
            /*play*/
            let setup = (function(out){
                out.mountains = function(){

                }
                out.sea = function(){

                }
                out.camp = function(){
                    
                }
            return out })({})
            function play (){

            }
            /*index*/
                let loader = new GLTFLoader();
                let index = (function(out){
                    out.r = (function(out){ // rapier
                        out.world= new RAPIER.World({ x: 0.0, y: -9.81, z: 0.0 })

                        out.addPhysicsToMesh= function(mesh,physics=true){

                            let {x,y,z} = mesh.position;
                            const box = mesh.geometry.boundingBox;
                            const size = new THREE.Vector3();
                            box.getSize(size);     
                            
                            let rigidBodyDesc;
                            if (physics){
                                rigidBodyDesc = RAPIER.RigidBodyDesc.dynamic().setTranslation(x, y, z).setCanSleep(true).setRotation(mesh.quaternion);
                            } else {
                                rigidBodyDesc = RAPIER.RigidBodyDesc.fixed().setTranslation(x, y, z).setCanSleep(true).setRotation(mesh.quaternion);
                            }

                            let body = out.world.createRigidBody(rigidBodyDesc);
                            let colliderDesc = RAPIER.ColliderDesc.cuboid(size.x/2, size.y/2, size.z/2);
                            let collider = world.createCollider(colliderDesc, rigid);
                        }
                     return out })({})
                        
                    
                    out.t = (function(out){ //threejs
                        out.scene= new THREE.Scene(),

                        out.camera= new THREE.PerspectiveCamera( 90, window.innerWidth / window.innerHeight, 0.01, 5000 )

                        out.renderer= new THREE.WebGLRenderer({ antialias: true }).setSize( innerWidth, innerHeight )

                        out.createSkybox= function(angle) {
                            const sky = new Sky();
                            sky.scale.setScalar( 450000 );

                            const phi = angle * pi/180//MathUtils.degToRad( 90 );
                            const theta = 180 * pi/180//MathUtils.degToRad( 180 );
                            const sunPosition = new THREE.Vector3().setFromSphericalCoords( 10, phi, theta );

                            sky.material.uniforms.sunPosition.value = sunPosition;

                            out.scene.add( sky );
                        }



                     return out })({})
                    out.f = (function(out){ //functions
                        out.constrain= function(x,a,b){
                            return x<a ? a : x>b ? b : x
                        }
                        
                        out.deg= function(x){
                            return x*57.29577951
                        }
                        
                        out.rad= function(x){
                            return a*0.01745329252
                        }
                        out.loadModel= function(path){
                            loader.load(path, gltf => {
                                const clone = gltf.scene.clone();
                                return clone;
                            });
                        }
                        out.spawnSpartan= function(x,y,z){
                            
                        }
                        out.spawnPersian= function(x,y,z){
                            
                        }
                     return out })({})
                    out.v = (function(out){ // variables
                        out.scene = 'title'
                     return out })({})
                    
                    out.k = (function(controls){ //keys
                        controls.mouseX=controls.mouseY=0
                        controls.mousePressed=controls.mouseClicked=false
                        controls.keysHeld={}
                        controls.keysPressed={}
                        controls.shift=false

                        uiCanvas.onmousemove=function(e){
                            controls.mouseX+=e.movementX
                            controls.mouseY+=e.movementY
                        }
                        
                        uiCanvas.onmousedown=function(){
                            if (!controls.mousePressed) { 
                                controls.mouseClicked = true; // âœ… Trigger only on the first press
                            }
                            controls.mousePressed=true
                        }
                        
                        uiCanvas.onmouseup=function(){
                            controls.mousePressed=false
                        }
                        
                        document.onkeydown=function(e){
                            if (   controls.keysHeld[e.code.toString()] !== true   ) {

                                controls.keysPressed[e.code.toString()]=true

                            } else {

                                controls.keysPressed[e.code.toString()]=false

                            }

                            controls.keysHeld[e.code.toString()]=true
                        }
                        
                        document.onkeyup=function(e){
                            controls.keysHeld[e.code.toString()]=false
                        }
                        controls.update = function() {
                            controls.keysPressed={}
                            controls.mouseClicked=false
                        }
                                                
                        return controls
                        
                     })({})
                return out })({})
                console.log(index )
            /*draw*/
            function draw() {
                ui_ctx.clearRect(0, 0, uiCanvas.width, uiCanvas.height);


                if (showStartButton) {
                    drawStartButton();
                } else if (index.v.scene === 'title'){
                    drawTitle();
                } else {
                    play();
                }


                requestAnimationFrame(draw);
            }
            draw()
        </script>            
    </body>
</html>